<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Dashboard - Job Applications</title>
    <!-- Tailwind CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- SweetAlert2 for Modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" type="image/png" href="https://favicon.io/favicon-16x16.png">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .table-container {
            overflow-x: auto;
        }

        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #4b5563;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        .gradient-button {
            background: linear-gradient(to right, #3B82F6, #7C3AED);
            transition: background 0.3s;
        }

        .gradient-button:hover {
            background: linear-gradient(to right, #2563EB, #6D28D9);
        }

        th {
            cursor: pointer;
        }

        .loading-spinner {
            display: inline-block;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            display: inline-block;
        }
        
        .compact-table td, .compact-table th {
            padding: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-purple-600 to-blue-500 text-white py-6 text-center shadow-lg">
        <h1 class="text-3xl font-bold">HR Dashboard</h1>
        <p class="text-lg mt-2">Manage Job Applications and Provide Offer Letters</p>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto p-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-50 transition" onclick="showSection('pending')">
                <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-briefcase mr-2"></i>Pending</h3>
                <p class="text-2xl font-bold text-yellow-500" id="pendingCount">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-50 transition" onclick="showSection('approved')">
                <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-check-circle mr-2"></i>Approved</h3>
                <p class="text-2xl font-bold text-green-500" id="approvedCount">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-50 transition" onclick="showSection('rejected')">
                <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-times-circle mr-2"></i>Rejected</h3>
                <p class="text-2xl font-bold text-red-500" id="rejectedCount">0</p>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" class="w-full p-2 border rounded-lg" placeholder="Search by Reference ID, Name, or Email">
                </div>
                <div class="flex-1">
                    <select id="departmentFilter" class="w-full p-2 border rounded-lg">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="flex-1">
                    <select id="jobRoleFilter" class="w-full p-2 border rounded-lg">
                        <option value="">All Job Roles</option>
                    </select>
                </div>
                <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition" onclick="applyFilters()">
                    Apply Filters
                </button>
            </div>
        </div>

        <!-- Sections -->
        <div id="pendingSection" class="dashboard bg-white p-6 rounded-lg shadow-md hidden fade-in">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-briefcase mr-2"></i>Pending Applications</h2>
            <div class="table-container">
                <table class="w-full border-collapse compact-table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-2 text-left text-gray-600 font-semibold">Ref ID</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Name</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Email</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Job Role</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Status</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Applied Date</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingApplicationsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="approvedSection" class="dashboard bg-white p-6 rounded-lg shadow-md hidden fade-in">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-check-circle mr-2"></i>Approved Applications</h2>
            <div class="table-container">
                <table class="w-full border-collapse compact-table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-2 text-left text-gray-600 font-semibold">Ref ID</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Name</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Email</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Job Role</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Status</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Offer Letter</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Applied Date</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="approvedApplicationsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="rejectedSection" class="dashboard bg-white p-6 rounded-lg shadow-md hidden fade-in">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-times-circle mr-2"></i>Rejected Applications</h2>
            <div class="table-container">
                <table class="w-full border-collapse compact-table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-2 text-left text-gray-600 font-semibold">Ref ID</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Name</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Email</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Job Role</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Status</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Applied Date</th>
                            <th class="p-2 text-left text-gray-600 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rejectedApplicationsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-3xl w-full modal-content">
            <i class="fas fa-times modal-close" onclick="closeModal()"></i>
            <h2 class="text-xl font-semibold mb-4">Application Details</h2>
            <div id="applicationDetails" class="mb-4"></div>
            <div class="download-section">
                <h3 class="text-lg font-semibold mb-2">Documents</h3>
                <div id="documentLinks" class="mb-4 grid grid-cols-1 gap-2"></div>
            </div>
            <div class="status-section" id="statusSection">
                <h3 class="text-lg font-semibold mb-2">Update Status</h3>
                <div class="flex items-center">
                    <select id="statusSelect" class="p-2 border rounded-lg flex-1">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <button class="gradient-button text-white px-4 py-2 rounded-lg ml-4" onclick="confirmStatusUpdate()">Update</button>
                </div>
            </div>
            <div class="offer-letter-section mt-4" id="offerLetterUploadSection" style="display: none;">
                <h3 class="text-lg font-semibold mb-2">Upload Offer Letter</h3>
                <input type="file" id="offerLetterInput" accept=".pdf" class="mb-2 w-full">
                <button class="gradient-button text-white px-4 py-2 rounded-lg w-full" onclick="uploadOfferLetter()">Upload</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3409' : 'http://13.60.241.211:3409';
        let currentApplicationId = null;
        let applicationsData = [];
        let currentSection = 'pending';

        window.onload = () => {
            fetchApplications();
        };

        async function fetchApplications() {
            try {
                console.log('Fetching applications from:', `${BASE_URL}/api/applications`);
                const tbodies = ['pendingApplicationsBody', 'approvedApplicationsBody', 'rejectedApplicationsBody'];
                tbodies.forEach(id => {
                    document.getElementById(id).innerHTML = '<tr><td colspan="9" class="p-3 text-center"><span class="loading-spinner"></span> Loading...</td></tr>';
                });

                const response = await fetch(`${BASE_URL}/api/applications`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                console.log('Fetch response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Parsed server response:', result);

                if (!result.success) throw new Error(result.message || 'Failed to fetch applications');

                applicationsData = Array.isArray(result.data) ? result.data : [];
                applicationsData.forEach(app => {
                    console.log(`Application ID ${app.id}: referenceId=${app.reference_id || 'N/A'}, status=${app.status || 'N/A'}, offer_letter_path=${app.offer_letter_path || 'N/A'}`);
                });

                populateFilters();
                updateCounts();
                applyFilters();
                showSection(currentSection);
            } catch (error) {
                console.error('Fetch applications error:', error);
                applicationsData = [];
                updateCounts();
                applyFilters();
                showSection(currentSection);
                Swal.fire({
                    icon: 'error',
                    title: 'Error Fetching Applications',
                    text: error.message.includes('Failed to fetch')
                        ? 'Unable to connect to the server. Please ensure the server is running.'
                        : error.message.includes('CORS')
                        ? 'CORS error: Please check server configuration.'
                        : 'Failed to load applications. Please try again later.'
                });
            }
        }

        function updateCounts() {
            const pendingCount = applicationsData.filter(app => app.status === 'Pending').length;
            const approvedCount = applicationsData.filter(app => app.status === 'Approved').length;
            const rejectedCount = applicationsData.filter(app => app.status === 'Rejected').length;

            console.log(`Counts - Pending: ${pendingCount}, Approved: ${approvedCount}, Rejected: ${rejectedCount}`);

            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('approvedCount').textContent = approvedCount;
            document.getElementById('rejectedCount').textContent = rejectedCount;
        }

        function populateFilters() {
            const departmentFilter = document.getElementById('departmentFilter');
            const jobRoleFilter = document.getElementById('jobRoleFilter');

            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            jobRoleFilter.innerHTML = '<option value="">All Job Roles</option>';

            const departments = [...new Set(applicationsData.map(app => app.department).filter(Boolean))];
            const jobRoles = [...new Set(applicationsData.map(app => app.job_role).filter(Boolean))];

            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentFilter.appendChild(option);
            });

            jobRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                jobRoleFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            const jobRoleFilter = document.getElementById('jobRoleFilter').value;

            const filteredData = applicationsData.filter(app => {
                const matchesSearch = !searchQuery || 
                    (app.reference_id?.toLowerCase().includes(searchQuery) ||
                     app.full_name?.toLowerCase().includes(searchQuery) ||
                     app.email?.toLowerCase().includes(searchQuery));
                const matchesDepartment = !departmentFilter || app.department === departmentFilter;
                const matchesJobRole = !jobRoleFilter || app.job_role === jobRoleFilter;
                return matchesSearch && matchesDepartment && matchesJobRole;
            });

            console.log('Filtered applications count:', filteredData.length);
            displayApplications(filteredData);
        }

        function showSection(section) {
            currentSection = section;
            ['pendingSection', 'approvedSection', 'rejectedSection'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(`${section}Section`).classList.remove('hidden');
            applyFilters();
        }

        function displayApplications(applications = []) {
            const pendingTbody = document.getElementById('pendingApplicationsBody');
            const approvedTbody = document.getElementById('approvedApplicationsBody');
            const rejectedTbody = document.getElementById('rejectedApplicationsBody');

            pendingTbody.innerHTML = '';
            approvedTbody.innerHTML = '';
            rejectedTbody.innerHTML = '';

            if (!applications.length) {
                const noDataRowPending = '<tr><td colspan="7" class="p-3 text-center text-gray-500">No applications found.</td></tr>';
                const noDataRowApproved = '<tr><td colspan="8" class="p-3 text-center text-gray-500">No applications found.</td></tr>';
                const noDataRowRejected = '<tr><td colspan="7" class="p-3 text-center text-gray-500">No applications found.</td></tr>';
                pendingTbody.innerHTML = noDataRowPending;
                approvedTbody.innerHTML = noDataRowApproved;
                rejectedTbody.innerHTML = noDataRowRejected;
                return;
            }

            applications.forEach(app => {
                console.log(`Rendering application ID ${app.id}: status=${app.status || 'N/A'}`);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                const truncatedName = app.full_name && app.full_name.length > 30 
                    ? `<span class="truncate-text" title="${app.full_name}">${app.full_name.substring(0, 27)}...</span>`
                    : displayValue(app.full_name);

                const baseRowContent = `
                    <td class="p-2">${displayValue(app.reference_id)}</td>
                    <td class="p-2">${truncatedName}</td>
                    <td class="p-2">${displayValue(app.email)}</td>
                    <td class="p-2">${displayValue(app.job_role)}</td>
                    <td class="p-2">
                        <span class="${
                            app.status === 'Pending' ? 'text-yellow-500' :
                            app.status === 'Approved' ? 'text-green-500' :
                            'text-red-500'
                        } font-medium">${displayValue(app.status)}</span>
                    </td>
                    <td class="p-2">${formatDate(app.created_at)}</td>
                    <td class="p-2">
                        <button class="gradient-button text-white px-3 py-1 rounded-lg text-sm" onclick="viewDetails(${app.id})">View Details</button>
                    </td>
                `;

                if (app.status === 'Approved') {
                    row.innerHTML = `
                        <td class="p-2">${displayValue(app.reference_id)}</td>
                        <td class="p-2">${truncatedName}</td>
                        <td class="p-2">${displayValue(app.email)}</td>
                        <td class="p-2">${displayValue(app.job_role)}</td>
                        <td class="p-2">
                            <span class="text-green-500 font-medium">${displayValue(app.status)}</span>
                        </td>
                        <td class="p-2">
                            ${app.offer_letter_path 
                                ? '<span class="text-blue-500 font-medium">Provided</span>' 
                                : '<span class="text-gray-500">Not Provided</span>'}
                        </td>
                        <td class="p-2">${formatDate(app.created_at)}</td>
                        <td class="p-2">
                            <button class="gradient-button text-white px-3 py-1 rounded-lg text-sm" onclick="viewDetails(${app.id})">View Details</button>
                        </td>
                    `;
                    approvedTbody.appendChild(row);
                } else if (app.status === 'Rejected') {
                    row.innerHTML = baseRowContent;
                    rejectedTbody.appendChild(row);
                } else {
                    row.innerHTML = baseRowContent;
                    pendingTbody.appendChild(row);
                }
            });
        }

        async function viewDetails(id) {
            try {
                console.log(`Fetching details for application ID ${id} from: ${BASE_URL}/api/applications/${id}`);
                document.getElementById('applicationDetails').innerHTML = '<div class="p-3 text-center"><span class="loading-spinner"></span> Loading details...</div>';

                const response = await fetch(`${BASE_URL}/api/applications/${id}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                console.log('Fetch details response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch details error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Parsed details response:', result);

                if (!result.success) throw new Error(result.message || 'Failed to fetch application details');

                currentApplicationId = id;
                showApplicationDetails(result.data || {});
            } catch (error) {
                console.error('Fetch details error:', error);
                document.getElementById('applicationDetails').innerHTML = '';
                Swal.fire({
                    icon: 'error',
                    title: 'Error Fetching Details',
                    text: error.message.includes('Failed to fetch')
                        ? 'Unable to connect to the server. Please ensure the server is running.'
                        : error.message.includes('CORS')
                        ? 'CORS error: Please check server configuration.'
                        : 'Failed to load application details. Please try again.'
                });
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? '-' : date.toLocaleDateString('en-US');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? '-' : date.toLocaleString('en-US');
        }

        function displayValue(value) {
            return value !== null && value !== undefined ? value : '-';
        }

        function handleFileDownload(event) {
            event.preventDefault();
            const url = event.target.href;
            console.log('Downloading file:', url);
            fetch(url, { method: 'GET' })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    return response.blob();
                })
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = url.split('/').pop();
                    link.click();
                    window.URL.revokeObjectURL(link.href);
                })
                .catch(error => {
                    console.error('Download error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Download Error',
                        text: 'Failed to download the file. Please try again.'
                    });
                });
        }

        function showApplicationDetails(data) {
            console.log('Rendering application details:', data);
            const detailsDiv = document.getElementById('applicationDetails');
            const documentsDiv = document.getElementById('documentLinks');
            const statusSelect = document.getElementById('statusSelect');
            const offerLetterSection = document.getElementById('offerLetterUploadSection');
            const statusSection = document.getElementById('statusSection');

            let experienceDetails = '';
            if (data.experience_status === 'experienced') {
                experienceDetails = `
                    <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Years of Experience:</strong> <span>${displayValue(data.years_of_experience)}</span></div>
                    <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Previous Company:</strong> <span>${displayValue(data.previous_company)}</span></div>
                    <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Previous Job Role:</strong> <span>${displayValue(data.previous_job_role)}</span></div>
                `;
            }

            detailsDiv.innerHTML = `
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Reference ID:</strong> <span>${displayValue(data.reference_id)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Full Name:</strong> <span>${displayValue(data.full_name)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Email:</strong> <span>${displayValue(data.email)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Mobile Number:</strong> <span>${displayValue(data.mobile_number)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Department:</strong> <span>${displayValue(data.department)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Job Role:</strong> <span>${displayValue(data.job_role)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Date of Birth:</strong> <span>${formatDate(data.dob)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Father's Name:</strong> <span>${displayValue(data.father_name)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Permanent Address:</strong> <span>${displayValue(data.permanent_address)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Expected Salary:</strong> <span>${data.expected_salary ? 'â‚¹' + parseInt(data.expected_salary).toLocaleString('en-IN') : '-'}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Interview Date:</strong> <span>${formatDate(data.interview_date)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Joining Date:</strong> <span>${formatDate(data.joining_date)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Employment Type:</strong> <span>${displayValue(data.employment_type)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Branch Location:</strong> <span>${displayValue(data.branch_location)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">SSC Year:</strong> <span>${displayValue(data.ssc_year)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">SSC Percentage/CGPA:</strong> <span>${displayValue(data.ssc_percentage)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Intermediate Year:</strong> <span>${displayValue(data.intermediate_year)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Intermediate Percentage/CGPA:</strong> <span>${displayValue(data.intermediate_percentage)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">College/University:</strong> <span>${displayValue(data.college_name)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Registration Number:</strong> <span>${displayValue(data.register_number)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Graduation Year:</strong> <span>${displayValue(data.graduation_year)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Graduation Percentage/CGPA:</strong> <span>${displayValue(data.graduation_percentage)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Additional Certifications:</strong> <span>${displayValue(data.additional_certifications)}</span></div>
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Experience Status:</strong> <span>${displayValue(data.experience_status)}</span></div>
                ${experienceDetails}
                <div class="mb-2"><strong class="w-48 inline-block text-gray-600">Applied On:</strong> <span>${formatDateTime(data.created_at)}</span></div>
            `;

            documentsDiv.innerHTML = `
                <div class="flex items-center">
                    <strong class="w-48 text-gray-600">SSC Document:</strong>
                    ${data.ssc_doc_path 
                        ? `<a href="${BASE_URL}/api/files/${encodeURIComponent(data.ssc_doc_path)}" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition" onclick="handleFileDownload(event)">Download SSC</a>`
                        : '<span>No file uploaded</span>'}
                </div>
                <div class="flex items-center">
                    <strong class="w-48 text-gray-600">Intermediate Document:</strong>
                    ${data.intermediate_doc_path 
                        ? `<a href="${BASE_URL}/api/files/${encodeURIComponent(data.intermediate_doc_path)}" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition" onclick="handleFileDownload(event)">Download Intermediate</a>`
                        : '<span>No file uploaded</span>'}
                </div>
                <div class="flex items-center">
                    <strong class="w-48 text-gray-600">Graduation Document:</strong>
                    ${data.graduation_doc_path 
                        ? `<a href="${BASE_URL}/api/files/${encodeURIComponent(data.graduation_doc_path)}" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition" onclick="handleFileDownload(event)">Download Graduation</a>`
                        : '<span>No file uploaded</span>'}
                </div>
                <div class="flex items-center">
                    <strong class="w-48 text-gray-600">Additional Document:</strong>
                    ${data.additional_files_path 
                        ? `<a href="${BASE_URL}/api/files/${encodeURIComponent(data.additional_files_path)}" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition" onclick="handleFileDownload(event)">Download Additional</a>`
                        : '<span>No file uploaded</span>'}
                </div>
                <div class="flex items-center">
                    <strong class="w-48 text-gray-600">Offer Letter:</strong>
                    ${data.offer_letter_path 
                        ? `<a href="${BASE_URL}/api/files/${encodeURIComponent(data.offer_letter_path)}" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition" onclick="handleFileDownload(event)">Download Offer Letter</a>`
                        : '<span>No offer letter uploaded</span>'}
                </div>
            `;

            statusSelect.value = data.status || 'Pending';
            offerLetterSection.style.display = data.status === 'Approved' ? 'block' : 'none';
            statusSection.style.display = data.status === 'Pending' ? 'block' : 'none';

            offerLetterSection.innerHTML = `
                <h3 class="text-lg font-semibold mb-2">Upload Offer Letter</h3>
                ${data.offer_letter_path ? '<p class="text-yellow-500 mb-2">Note: An offer letter is already uploaded. Uploading a new one will replace it.</p>' : ''}
                <input type="file" id="offerLetterInput" accept=".pdf" class="mb-2 w-full">
                <button class="gradient-button text-white px-4 py-2 rounded-lg w-full" onclick="uploadOfferLetter()">Upload</button>
            `;

            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function confirmStatusUpdate() {
            const status = document.getElementById('statusSelect').value;
            Swal.fire({
                title: `Are you sure?`,
                text: `You are about to mark this application as ${status}. This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, update it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateStatus();
                }
            });
        }

        async function updateStatus() {
            const status = document.getElementById('statusSelect').value;
            if (!currentApplicationId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No application selected'
                });
                return;
            }

            try {
                console.log(`Updating status for application ID ${currentApplicationId} to ${status}`);
                const response = await fetch(`${BASE_URL}/api/applications/${currentApplicationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                console.log('Update status response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Update status error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Update status response:', result);
                if (!result.success) throw new Error(result.message);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Status updated successfully!'
                });
                closeModal();
                fetchApplications();
            } catch (error) {
                console.error('Update status error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error Updating Status',
                    text: error.message.includes('Failed to fetch')
                        ? 'Unable to connect to the server. Please ensure the server is running.'
                        : error.message.includes('CORS')
                        ? 'CORS error: Please check server configuration.'
                        : 'Failed to update status. Please try again.'
                });
            }
        }

        async function uploadOfferLetter() {
            const fileInput = document.getElementById('offerLetterInput');
            const file = fileInput.files[0];

            if (!file) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please select a file to upload'
                });
                return;
            }

            if (file.type !== 'application/pdf') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Only PDF files are allowed'
                });
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'File size must be less than 5MB'
                });
                return;
            }

            const formData = new FormData();
            formData.append('offerLetter', file);

            try {
                console.log(`Uploading offer letter for application ID ${currentApplicationId}`);
                const response = await fetch(`${BASE_URL}/api/applications/${currentApplicationId}/offer-letter`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Upload offer letter response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload offer letter error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Upload offer letter response:', result);
                if (!result.success) throw new Error(result.message);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Offer letter uploaded successfully!'
                });
                closeModal();
                fetchApplications();
            } catch (error) {
                console.error('Upload offer letter error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error Uploading Offer Letter',
                    text: error.message.includes('Failed to fetch')
                        ? 'Unable to connect to the server. Please ensure the server is running.'
                        : error.message.includes('CORS')
                        ? 'CORS error: Please check server configuration.'
                        : 'Failed to upload offer letter. Please try again.'
                });
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            document.getElementById('applicationDetails').innerHTML = '';
            document.getElementById('documentLinks').innerHTML = '';
            document.getElementById('offerLetterUploadSection').style.display = 'none';
            document.getElementById('statusSection').style.display = 'block';
            currentApplicationId = null;
        }

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('departmentFilter').addEventListener('change', applyFilters);
        document.getElementById('jobRoleFilter').addEventListener('change', applyFilters);
    </script>
</body>
</html>